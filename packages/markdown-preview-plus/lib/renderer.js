"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const util_1 = require("./util");
const util_common_1 = require("./util-common");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function render(options) {
    const text = options.text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    let error;
    if (util_1.atomConfig().renderer === 'pandoc') {
        try {
            html = await pandocHelper.renderPandoc(text, options.filePath, options.renderLaTeX);
        }
        catch (err) {
            const e = err;
            if (e.html === undefined)
                throw e;
            error = e.message;
            html = e.html;
        }
    }
    else {
        html = markdownIt.render(text, options.renderLaTeX);
    }
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    sanitize(doc);
    if (options.mode === 'normal') {
        options.imageWatcher.clear();
        resolveImagePaths(doc, options.filePath, false, undefined, options.imageWatcher);
    }
    else {
        switch (options.mode) {
            case 'save':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    savePath: options.savePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnSaveAsHTMLBehaviour,
                });
                break;
            case 'copy':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnCopyAsHTMLBehaviour,
                });
                break;
            default:
                throw invalidMode(options.mode);
        }
    }
    let defaultCodeLanguage = 'text';
    if ((options.grammar && options.grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!(util_1.atomConfig().renderer === 'pandoc' &&
        util_1.atomConfig().pandocConfig.useNativePandocCodeStyles)) {
        highlightCodeBlocks(doc, defaultCodeLanguage, options.mode !== 'normal');
    }
    if (error) {
        const errd = doc.createElement('div');
        const msgel = doc.createElement('code');
        msgel.innerText = error;
        errd.innerHTML = `<h1>Pandoc Error:</h1>${msgel.outerHTML}<hr>`;
        doc.body.insertBefore(errd, doc.body.firstElementChild);
    }
    return doc;
}
exports.render = render;
function invalidMode(mode) {
    return new Error(`Invalid render mode ${JSON.stringify(mode)}`);
}
function sanitize(doc) {
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
}
function handleImages(opts) {
    const relativize = opts.behaviour === 'relativized';
    switch (opts.behaviour) {
        case 'relativized':
        case 'absolutized':
            resolveImagePaths(opts.doc, opts.filePath, relativize, opts.savePath);
            break;
        case 'untouched':
    }
}
function resolveImagePaths(doc, filePath, relativize, savePath, imageWatcher) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const media = util_common_1.getMedia(doc);
    Array.from(media).map(function (img) {
        let src = img.getAttribute('src');
        if (src) {
            if (util_1.atomConfig().renderer !== 'pandoc') {
                src = decodeURI(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (process.resourcesPath && src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (relativize && (filePath !== undefined || savePath !== undefined)) {
                const fp = savePath !== undefined ? savePath : filePath;
                src = path.relative(path.dirname(fp), src);
            }
            if (imageWatcher) {
                const v = imageWatcher.watch(src);
                if (v !== undefined)
                    src = `${src}?v=${v}`;
            }
            img.src = src;
        }
    });
}
function highlightCodeBlocks(domFragment, defaultLanguage, copyHTML) {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const addClass = copyHTML ? 'editor-colors ' : '';
        preElement.outerHTML = highlight({
            fileContents: codeBlock.textContent.replace(/\n$/, ''),
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: copyHTML ? false : true,
            editorDiv: true,
            editorDivTag: copyHTML ? 'pre' : 'atom-text-editor',
            editorDivClass: fenceName ? `${addClass}lang-${fenceName}` : addClass,
        });
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsNENBQTRDO0FBQzVDLGdEQUFnRDtBQUNoRCxtREFBbUQ7QUFDbkQseURBQXNEO0FBRXRELGlDQUErQztBQUMvQywrQ0FBd0M7QUFHeEMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBaUJwQyxLQUFLLFVBQVUsTUFBTSxDQUFDLE9BQXNCO0lBR2pELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRW5FLElBQUksSUFBSSxDQUFBO0lBQ1IsSUFBSSxLQUFLLENBQUE7SUFDVCxJQUFJLGlCQUFVLEVBQUUsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO1FBQ3RDLElBQUk7WUFDRixJQUFJLEdBQUcsTUFBTSxZQUFZLENBQUMsWUFBWSxDQUNwQyxJQUFJLEVBQ0osT0FBTyxDQUFDLFFBQVEsRUFDaEIsT0FBTyxDQUFDLFdBQVcsQ0FDcEIsQ0FBQTtTQUNGO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLENBQUMsR0FBRyxHQUFnQyxDQUFBO1lBQzFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTO2dCQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQ2pDLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBaUIsQ0FBQTtZQUMzQixJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQWMsQ0FBQTtTQUN4QjtLQUNGO1NBQU07UUFDTCxJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0tBQ3BEO0lBQ0Qs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T0FBTyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUE7UUFDbkMsTUFBTSxTQUFTLEdBQUcsT0FBTztZQUN2QixDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxFQUFFLENBQUM7WUFDN0MsQ0FBQyxDQUFDLGVBQWUsQ0FBQTtRQUVuQixNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7UUFDakQsVUFBVSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7WUFDL0IsWUFBWSxFQUFFLFNBQVMsQ0FBQyxXQUFZLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUM7WUFDdkQsU0FBUyxFQUFFLG9DQUFpQixDQUFDLFNBQVMsQ0FBQztZQUN2QyxJQUFJLEVBQUUsS0FBSztZQUNYLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUNqQyxTQUFTLEVBQUUsSUFBSTtZQUNmLFlBQVksRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsa0JBQWtCO1lBRW5ELGNBQWMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsUUFBUSxRQUFRLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRO1NBQ3RFLENBQUMsQ0FBQTtLQUNIO0lBRUQsT0FBTyxXQUFXLENBQUE7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgaGlnaGxpZ2h0ID0gcmVxdWlyZSgnYXRvbS1oaWdobGlnaHQnKVxuaW1wb3J0IHBhbmRvY0hlbHBlciA9IHJlcXVpcmUoJy4vcGFuZG9jLWhlbHBlcicpXG5pbXBvcnQgbWFya2Rvd25JdCA9IHJlcXVpcmUoJy4vbWFya2Rvd24taXQtaGVscGVyJykgLy8gRGVmZXIgdW50aWwgdXNlZFxuaW1wb3J0IHsgc2NvcGVGb3JGZW5jZU5hbWUgfSBmcm9tICcuL2V4dGVuc2lvbi1oZWxwZXInXG5pbXBvcnQgeyBHcmFtbWFyIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IGlzRmlsZVN5bmMsIGF0b21Db25maWcgfSBmcm9tICcuL3V0aWwnXG5pbXBvcnQgeyBnZXRNZWRpYSB9IGZyb20gJy4vdXRpbC1jb21tb24nXG5pbXBvcnQgeyBJbWFnZVdhdGNoZXIgfSBmcm9tICcuL2ltYWdlLXdhdGNoLWhlbHBlcidcblxuY29uc3QgeyByZXNvdXJjZVBhdGggfSA9IGF0b20uZ2V0TG9hZFNldHRpbmdzKClcbmNvbnN0IHBhY2thZ2VQYXRoID0gcGF0aC5kaXJuYW1lKF9fZGlybmFtZSlcblxuZXhwb3J0IHR5cGUgUmVuZGVyTW9kZSA9ICdub3JtYWwnIHwgJ2NvcHknIHwgJ3NhdmUnXG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tbW9uUmVuZGVyT3B0aW9uczxUIGV4dGVuZHMgUmVuZGVyTW9kZT4ge1xuICB0ZXh0OiBzdHJpbmdcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZFxuICBncmFtbWFyPzogR3JhbW1hclxuICByZW5kZXJMYVRlWDogYm9vbGVhblxuICBtb2RlOiBUXG59XG5cbmV4cG9ydCB0eXBlIFJlbmRlck9wdGlvbnMgPVxuICB8IChDb21tb25SZW5kZXJPcHRpb25zPCdub3JtYWwnIHwgJ2NvcHknPiAmIHsgaW1hZ2VXYXRjaGVyOiBJbWFnZVdhdGNoZXIgfSlcbiAgfCAoQ29tbW9uUmVuZGVyT3B0aW9uczwnc2F2ZSc+ICYgeyBzYXZlUGF0aDogc3RyaW5nIH0pXG4gIHwgKENvbW1vblJlbmRlck9wdGlvbnM8J2NvcHknPilcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlbmRlcihvcHRpb25zOiBSZW5kZXJPcHRpb25zKTogUHJvbWlzZTxIVE1MRG9jdW1lbnQ+IHtcbiAgLy8gUmVtb3ZlIHRoZSA8IWRvY3R5cGU+IHNpbmNlIG90aGVyd2lzZSBtYXJrZWQgd2lsbCBlc2NhcGUgaXRcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoamovbWFya2VkL2lzc3Vlcy8zNTRcbiAgY29uc3QgdGV4dCA9IG9wdGlvbnMudGV4dC5yZXBsYWNlKC9eXFxzKjwhZG9jdHlwZShcXHMrLiopPz5cXHMqL2ksICcnKVxuXG4gIGxldCBodG1sXG4gIGxldCBlcnJvclxuICBpZiAoYXRvbUNvbmZpZygpLnJlbmRlcmVyID09PSAncGFuZG9jJykge1xuICAgIHRyeSB7XG4gICAgICBodG1sID0gYXdhaXQgcGFuZG9jSGVscGVyLnJlbmRlclBhbmRvYyhcbiAgICAgICAgdGV4dCxcbiAgICAgICAgb3B0aW9ucy5maWxlUGF0aCxcbiAgICAgICAgb3B0aW9ucy5yZW5kZXJMYVRlWCxcbiAgICAgIClcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnN0IGUgPSBlcnIgYXMgRXJyb3IgJiB7IGh0bWw/OiBzdHJpbmcgfVxuICAgICAgaWYgKGUuaHRtbCA9PT0gdW5kZWZpbmVkKSB0aHJvdyBlXG4gICAgICBlcnJvciA9IGUubWVzc2FnZSBhcyBzdHJpbmdcbiAgICAgIGh0bWwgPSBlLmh0bWwgYXMgc3RyaW5nXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGh0bWwgPSBtYXJrZG93bkl0LnJlbmRlcih0ZXh0LCBvcHRpb25zLnJlbmRlckxhVGVYKVxuICB9XG4gIGNvbnN0IHBhcnNlciA9IG5ldyBET01QYXJzZXIoKVxuICBjb25zdCBkb2MgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKGh0bWwsICd0ZXh0L2h0bWwnKVxuICBzYW5pdGl6ZShkb2MpXG4gIGlmIChvcHRpb25zLm1vZGUgPT09ICdub3JtYWwnKSB7XG4gICAgb3B0aW9ucy5pbWFnZVdhdGNoZXIuY2xlYXIoKVxuICAgIHJlc29sdmVJbWFnZVBhdGhzKFxuICAgICAgZG9jLFxuICAgICAgb3B0aW9ucy5maWxlUGF0aCxcbiAgICAgIGZhbHNlLFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgb3B0aW9ucy5pbWFnZVdhdGNoZXIsXG4gICAgKVxuICB9IGVsc2Uge1xuICAgIHN3aXRjaCAob3B0aW9ucy5tb2RlKSB7XG4gICAgICBjYXNlICdzYXZlJzpcbiAgICAgICAgaGFuZGxlSW1hZ2VzKHtcbiAgICAgICAgICBkb2MsXG4gICAgICAgICAgZmlsZVBhdGg6IG9wdGlvbnMuZmlsZVBhdGgsXG4gICAgICAgICAgc2F2ZVBhdGg6IG9wdGlvbnMuc2F2ZVBhdGgsXG4gICAgICAgICAgYmVoYXZpb3VyOiBhdG9tQ29uZmlnKCkuc2F2ZUNvbmZpZy5tZWRpYU9uU2F2ZUFzSFRNTEJlaGF2aW91cixcbiAgICAgICAgfSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ2NvcHknOlxuICAgICAgICBoYW5kbGVJbWFnZXMoe1xuICAgICAgICAgIGRvYyxcbiAgICAgICAgICBmaWxlUGF0aDogb3B0aW9ucy5maWxlUGF0aCxcbiAgICAgICAgICBiZWhhdmlvdXI6IGF0b21Db25maWcoKS5zYXZlQ29uZmlnLm1lZGlhT25Db3B5QXNIVE1MQmVoYXZpb3VyLFxuICAgICAgICB9KVxuICAgICAgICBicmVha1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgaW52YWxpZE1vZGUob3B0aW9ucy5tb2RlKVxuICAgIH1cbiAgfVxuICBsZXQgZGVmYXVsdENvZGVMYW5ndWFnZTogc3RyaW5nID0gJ3RleHQnXG4gIC8vIERlZmF1bHQgY29kZSBibG9ja3MgdG8gYmUgY29mZmVlIGluIExpdGVyYXRlIENvZmZlZVNjcmlwdCBmaWxlc1xuICBpZiAoKG9wdGlvbnMuZ3JhbW1hciAmJiBvcHRpb25zLmdyYW1tYXIuc2NvcGVOYW1lKSA9PT0gJ3NvdXJjZS5saXRjb2ZmZWUnKSB7XG4gICAgZGVmYXVsdENvZGVMYW5ndWFnZSA9ICdjb2ZmZWUnXG4gIH1cbiAgaWYgKFxuICAgICEoXG4gICAgICBhdG9tQ29uZmlnKCkucmVuZGVyZXIgPT09ICdwYW5kb2MnICYmXG4gICAgICBhdG9tQ29uZmlnKCkucGFuZG9jQ29uZmlnLnVzZU5hdGl2ZVBhbmRvY0NvZGVTdHlsZXNcbiAgICApXG4gICkge1xuICAgIGhpZ2hsaWdodENvZGVCbG9ja3MoZG9jLCBkZWZhdWx0Q29kZUxhbmd1YWdlLCBvcHRpb25zLm1vZGUgIT09ICdub3JtYWwnKVxuICB9XG4gIGlmIChlcnJvcikge1xuICAgIGNvbnN0IGVycmQgPSBkb2MuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgICBjb25zdCBtc2dlbCA9IGRvYy5jcmVhdGVFbGVtZW50KCdjb2RlJylcbiAgICBtc2dlbC5pbm5lclRleHQgPSBlcnJvclxuICAgIGVycmQuaW5uZXJIVE1MID0gYDxoMT5QYW5kb2MgRXJyb3I6PC9oMT4ke21zZ2VsLm91dGVySFRNTH08aHI+YFxuICAgIGRvYy5ib2R5Lmluc2VydEJlZm9yZShlcnJkLCBkb2MuYm9keS5maXJzdEVsZW1lbnRDaGlsZClcbiAgfVxuICByZXR1cm4gZG9jXG59XG5cbmZ1bmN0aW9uIGludmFsaWRNb2RlKG1vZGU6IG5ldmVyKSB7XG4gIHJldHVybiBuZXcgRXJyb3IoYEludmFsaWQgcmVuZGVyIG1vZGUgJHtKU09OLnN0cmluZ2lmeShtb2RlKX1gKVxufVxuXG5mdW5jdGlvbiBzYW5pdGl6ZShkb2M6IEhUTUxEb2N1bWVudCkge1xuICAvLyBEbyBub3QgcmVtb3ZlIE1hdGhKYXggc2NyaXB0IGRlbGltaXRlZCBibG9ja3NcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoXCJzY3JpcHQ6bm90KFt0eXBlXj0nbWF0aC90ZXgnXSlcIikuZm9yRWFjaCgoZWxlbSkgPT4ge1xuICAgIGVsZW0ucmVtb3ZlKClcbiAgfSlcbiAgY29uc3QgYXR0cmlidXRlc1RvUmVtb3ZlID0gW1xuICAgICdvbmFib3J0JyxcbiAgICAnb25ibHVyJyxcbiAgICAnb25jaGFuZ2UnLFxuICAgICdvbmNsaWNrJyxcbiAgICAnb25kYmNsaWNrJyxcbiAgICAnb25lcnJvcicsXG4gICAgJ29uZm9jdXMnLFxuICAgICdvbmtleWRvd24nLFxuICAgICdvbmtleXByZXNzJyxcbiAgICAnb25rZXl1cCcsXG4gICAgJ29ubG9hZCcsXG4gICAgJ29ubW91c2Vkb3duJyxcbiAgICAnb25tb3VzZW1vdmUnLFxuICAgICdvbm1vdXNlb3ZlcicsXG4gICAgJ29ubW91c2VvdXQnLFxuICAgICdvbm1vdXNldXAnLFxuICAgICdvbnJlc2V0JyxcbiAgICAnb25yZXNpemUnLFxuICAgICdvbnNjcm9sbCcsXG4gICAgJ29uc2VsZWN0JyxcbiAgICAnb25zdWJtaXQnLFxuICAgICdvbnVubG9hZCcsXG4gIF1cbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJyonKS5mb3JFYWNoKChlbGVtKSA9PlxuICAgIGF0dHJpYnV0ZXNUb1JlbW92ZS5tYXAoKGF0dHJpYnV0ZSkgPT4ge1xuICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlKVxuICAgIH0pLFxuICApXG59XG5cbmZ1bmN0aW9uIGhhbmRsZUltYWdlcyhvcHRzOiB7XG4gIGJlaGF2aW91cjogJ3JlbGF0aXZpemVkJyB8ICdhYnNvbHV0aXplZCcgfCAndW50b3VjaGVkJ1xuICBkb2M6IEhUTUxEb2N1bWVudFxuICBmaWxlUGF0aD86IHN0cmluZ1xuICBzYXZlUGF0aD86IHN0cmluZ1xufSkge1xuICBjb25zdCByZWxhdGl2aXplID0gb3B0cy5iZWhhdmlvdXIgPT09ICdyZWxhdGl2aXplZCdcbiAgc3dpdGNoIChvcHRzLmJlaGF2aW91cikge1xuICAgIGNhc2UgJ3JlbGF0aXZpemVkJzpcbiAgICBjYXNlICdhYnNvbHV0aXplZCc6XG4gICAgICByZXNvbHZlSW1hZ2VQYXRocyhvcHRzLmRvYywgb3B0cy5maWxlUGF0aCwgcmVsYXRpdml6ZSwgb3B0cy5zYXZlUGF0aClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSAndW50b3VjaGVkJzpcbiAgICAvKiBub29wICovXG4gIH1cbn1cblxuZnVuY3Rpb24gcmVzb2x2ZUltYWdlUGF0aHMoXG4gIGRvYzogSFRNTERvY3VtZW50LFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICByZWxhdGl2aXplOiBib29sZWFuLFxuICBzYXZlUGF0aD86IHN0cmluZyxcbiAgaW1hZ2VXYXRjaGVyPzogSW1hZ2VXYXRjaGVyLFxuKSB7XG4gIGNvbnN0IFtyb290RGlyZWN0b3J5XSA9IGF0b20ucHJvamVjdC5yZWxhdGl2aXplUGF0aChmaWxlUGF0aCB8fCAnJylcbiAgY29uc3QgbWVkaWEgPSBnZXRNZWRpYShkb2MpXG4gIEFycmF5LmZyb20obWVkaWEpLm1hcChmdW5jdGlvbihpbWcpIHtcbiAgICBsZXQgc3JjID0gaW1nLmdldEF0dHJpYnV0ZSgnc3JjJylcbiAgICBpZiAoc3JjKSB7XG4gICAgICBpZiAoYXRvbUNvbmZpZygpLnJlbmRlcmVyICE9PSAncGFuZG9jJykge1xuICAgICAgICBzcmMgPSBkZWNvZGVVUkkoc3JjKVxuICAgICAgfVxuXG4gICAgICBpZiAoc3JjLm1hdGNoKC9eKGh0dHBzP3xhdG9tfGRhdGEpOi8pKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHByb2Nlc3MucmVzb3VyY2VzUGF0aCAmJiBzcmMuc3RhcnRzV2l0aChwcm9jZXNzLnJlc291cmNlc1BhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHJlc291cmNlUGF0aCkpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBpZiAoc3JjLnN0YXJ0c1dpdGgocGFja2FnZVBhdGgpKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBpZiAoc3JjWzBdID09PSAnLycpIHtcbiAgICAgICAgaWYgKCFpc0ZpbGVTeW5jKHNyYykpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKHJvb3REaXJlY3RvcnkgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgc3JjID0gcGF0aC5qb2luKHJvb3REaXJlY3RvcnksIHNyYy5zdWJzdHJpbmcoMSkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgLy8gbm9vcFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChmaWxlUGF0aCkge1xuICAgICAgICBzcmMgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKGZpbGVQYXRoKSwgc3JjKVxuICAgICAgfVxuXG4gICAgICBpZiAocmVsYXRpdml6ZSAmJiAoZmlsZVBhdGggIT09IHVuZGVmaW5lZCB8fCBzYXZlUGF0aCAhPT0gdW5kZWZpbmVkKSkge1xuICAgICAgICBjb25zdCBmcCA9IHNhdmVQYXRoICE9PSB1bmRlZmluZWQgPyBzYXZlUGF0aCA6IGZpbGVQYXRoIVxuICAgICAgICBzcmMgPSBwYXRoLnJlbGF0aXZlKHBhdGguZGlybmFtZShmcCksIHNyYylcbiAgICAgIH1cblxuICAgICAgLy8gV2F0Y2ggaW1hZ2UgZm9yIGNoYW5nZXNcbiAgICAgIGlmIChpbWFnZVdhdGNoZXIpIHtcbiAgICAgICAgY29uc3QgdiA9IGltYWdlV2F0Y2hlci53YXRjaChzcmMpXG4gICAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQpIHNyYyA9IGAke3NyY30/dj0ke3Z9YFxuICAgICAgfVxuXG4gICAgICBpbWcuc3JjID0gc3JjXG4gICAgfVxuICB9KVxufVxuXG5mdW5jdGlvbiBoaWdobGlnaHRDb2RlQmxvY2tzKFxuICBkb21GcmFnbWVudDogRG9jdW1lbnQsXG4gIGRlZmF1bHRMYW5ndWFnZTogc3RyaW5nLFxuICBjb3B5SFRNTDogYm9vbGVhbixcbikge1xuICBjb25zdCBmb250RmFtaWx5ID0gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IuZm9udEZhbWlseScpXG4gIGlmIChmb250RmFtaWx5KSB7XG4gICAgZm9yIChjb25zdCBjb2RlRWxlbWVudCBvZiBBcnJheS5mcm9tKFxuICAgICAgZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnY29kZScpLFxuICAgICkpIHtcbiAgICAgIGNvZGVFbGVtZW50LnN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5XG4gICAgfVxuICB9XG5cbiAgZm9yIChjb25zdCBwcmVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlJykpKSB7XG4gICAgY29uc3QgY29kZUJsb2NrID1cbiAgICAgIHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgIT09IG51bGxcbiAgICAgICAgPyBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkXG4gICAgICAgIDogcHJlRWxlbWVudFxuICAgIGNvbnN0IGNiQ2xhc3MgPSBjb2RlQmxvY2suY2xhc3NOYW1lXG4gICAgY29uc3QgZmVuY2VOYW1lID0gY2JDbGFzc1xuICAgICAgPyBjYkNsYXNzLnJlcGxhY2UoL14obGFuZy18c291cmNlQ29kZSApLywgJycpXG4gICAgICA6IGRlZmF1bHRMYW5ndWFnZVxuXG4gICAgY29uc3QgYWRkQ2xhc3MgPSBjb3B5SFRNTCA/ICdlZGl0b3ItY29sb3JzICcgOiAnJ1xuICAgIHByZUVsZW1lbnQub3V0ZXJIVE1MID0gaGlnaGxpZ2h0KHtcbiAgICAgIGZpbGVDb250ZW50czogY29kZUJsb2NrLnRleHRDb250ZW50IS5yZXBsYWNlKC9cXG4kLywgJycpLFxuICAgICAgc2NvcGVOYW1lOiBzY29wZUZvckZlbmNlTmFtZShmZW5jZU5hbWUpLFxuICAgICAgbmJzcDogZmFsc2UsXG4gICAgICBsaW5lRGl2czogY29weUhUTUwgPyBmYWxzZSA6IHRydWUsXG4gICAgICBlZGl0b3JEaXY6IHRydWUsXG4gICAgICBlZGl0b3JEaXZUYWc6IGNvcHlIVE1MID8gJ3ByZScgOiAnYXRvbS10ZXh0LWVkaXRvcicsXG4gICAgICAvLyBUaGUgYGVkaXRvcmAgY2xhc3MgbWVzc2VzIHRoaW5ncyB1cCBhcyBgLmVkaXRvcmAgaGFzIGFic29sdXRlbHkgcG9zaXRpb25lZCBsaW5lc1xuICAgICAgZWRpdG9yRGl2Q2xhc3M6IGZlbmNlTmFtZSA/IGAke2FkZENsYXNzfWxhbmctJHtmZW5jZU5hbWV9YCA6IGFkZENsYXNzLFxuICAgIH0pXG4gIH1cblxuICByZXR1cm4gZG9tRnJhZ21lbnRcbn1cbiJdfQ==